/*
 * Copyright (c) 2017 HÃ¥vard Pettersson <mail@haavard.me>
 *
 * This file is part of Tox-WeeChat.
 *
 * Tox-WeeChat is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Tox-WeeChat is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Tox-WeeChat.  If not, see <http://www.gnu.org/licenses/>.
 */

#include <tox/tox.h>

#include "twc-utils.h"

#include "twc-bootstrap.h"

struct t_twc_bootstrap_node
{
    char const *const key;
    char const *const address;
    uint16_t const port;
};

/* bootstrap nodes generated by misc/getnodes.py
 * last generated 2017-02-18T22:26:38.420540 */
static struct t_twc_bootstrap_node const twc_bootstrap_nodes[] = {
    /* Maintainer: Manolis, location: DE */
    {"461FA3776EF0FA655F1A05477DF1B3B614F7D6B124F7DB1DD4FE3C08B03B640F",
     "130.133.110.14", 33445},
    /* Maintainer: Busindre, location: US */
    {"A179B09749AC826FF01F37A9613F6B57118AE014D4196A0E1105A98F93A54702",
     "205.185.116.116", 33445},
    /* Maintainer: Busindre, location: US */
    {"1D5A5F2F5D6233058BF0259B09622FB40B482E4FA0931EB8FD3AB8E7BF7DAF6F",
     "198.98.51.198", 33445},
    /* Maintainer: ray65536, location: NL */
    {"8E7D0B859922EF569298B4D261A8CCB5FEA14FB91ED412A7603A585A25698832",
     "108.61.165.198", 33445},
    /* Maintainer: fluke571, location: SI */
    {"3CEE1F054081E7A011234883BC4FC39F661A55B73637A5AC293DDF1251D9432B",
     "194.249.212.109", 33445},
    /* Maintainer: MAH69K, location: UA */
    {"DA4E4ED4B697F2E9B000EEFE3A34B554ACD3F45F5C96EAEA2516DD7FF9AF7B43",
     "185.25.116.107", 33445},
    /* Maintainer: Rotkaermota, location: SE */
    {"5823FB947FF24CF83DDFAC3F3BAA18F96EA2018B16CC08429CB97FA502F40C23",
     "95.215.46.114", 33445},
    /* Maintainer: tastytea, location: DE */
    {"2B2137E094F743AC8BD44652C55F41DFACC502F125E99E4FE24D40537489E32F",
     "5.189.176.217", 5190},
    /* Maintainer: pucetox, location: DE */
    {"7AED21F94D82B05774F697B209628CD5A9AD17E0C073D9329076A4C28ED28147",
     "148.251.23.146", 2306},
    /* Maintainer: ru_maniac, location: US */
    {"0FB96EEBFB1650DDB52E70CF773DDFCABE25A95CC3BB50FC251082E4B63EF82A",
     "104.223.122.15", 33445},
    /* Maintainer: wildermesser, location: CA */
    {"EDEE8F2E839A57820DE3DA4156D88350E53D4161447068A3457EE8F59F362414",
     "104.233.104.126", 33445},
    /* Maintainer: a68366, location: FR */
    {"AEC204B9A4501412D5F0BB67D9C81B5DB3EE6ADA64122D32A3E9B093D544327D",
     "51.254.84.212", 33445},
    /* Maintainer: ru_maniac, location: RU */
    {"24156472041E5F220D1FA11D9DF32F7AD697D59845701CDD7BE7D1785EB9DB39",
     "185.58.206.164", 33445},
    /* Maintainer: t3mp, location: RU */
    {"5625A62618CB4FCA70E147A71B29695F38CC65FF0CBD68AD46254585BE564802",
     "92.54.84.70", 33445},
    /* Maintainer: strngr, location: UA */
    {"FB4CE0DDEFEED45F26917053E5D24BDDA0FA0A3D83A672A9DA2375928B37023D",
     "195.93.190.6", 33445},
    /* Maintainer: nek, location: AM */
    {"2B9CD794424FD579044EC2FC5252B23DF8B4AAF239C25074F70B1090C3F8C83A",
     "109.75.40.105", 33445},
    /* Maintainer: HooinKyoma, location: SE */
    {"672DBE27B4ADB9D5FB105A6BB648B2F8FDB89B3323486A7A21968316E012023C",
     "95.215.44.78", 33445},
    /* Maintainer: LittleVulpix, location: FR */
    {"2C289F9F37C20D09DA83565588BF496FAB3764853FA38141817A72E3F18ACA0B",
     "163.172.136.118", 33445},
    /* Maintainer: Yani, location: NL */
    {"E59A0E71ADA20D35BD1B0957059D7EF7E7792B3D680AE25C6F4DBBA09114D165",
     "37.97.185.116", 33445},
    /* Maintainer: Cactus, location: RU */
    {"9906D65F2A4751068A59D30505C5FC8AE1A95E0843AE9372EAFA3BAB6AC16C2C",
     "193.124.186.205", 5228},
    /* Maintainer: linxon, location: RU */
    {"B38255EE4B054924F6D79A5E6E5889EC94B6ADF6FE9906F97A3D01E3D083223A",
     "80.87.193.193", 33445},
    /* Maintainer: Stranger, location: UA */
    {"813C8F4187833EF0655B10F7752141A352248462A567529A38B6BBF73E979307",
     "46.229.52.198", 33445},
    /* Maintainer: dvor, location: NL */
    {"2555763C8C460495B14157D234DD56B86300A2395554BCAE4621AC345B8C1B1B",
     "185.14.30.213", 443},
    /* Maintainer: ps, location: RU */
    {"98F5830A426C6BF165F895F04B897AFC4F57331B4BE0561F583C9F323194227B",
     "77.37.142.179", 33445},
    /* Maintainer: himura, location: RU */
    {"8F738BBC8FA9394670BCAB146C67A507B9907C8E564E28C2B59BEBB2FF68711B",
     "85.21.144.224", 33445},
    /* Maintainer: dolohow, location: FR */
    {"BEB71F97ED9C99C04B8489BB75579EB4DC6AB6F441B603D63533122F1858B51D",
     "37.187.122.30", 33445},
    /* Maintainer: clearmartin, location: DE */
    {"CD133B521159541FB1D326DE9850F5E56A6C724B5B8E5EB5CD8D950408E95707",
     "46.101.197.175", 443},
};

static int const twc_bootstrap_count =
    sizeof(twc_bootstrap_nodes) / sizeof(twc_bootstrap_nodes[0]);

/**
 * Bootstrap a Tox object with a DHT bootstrap node. Returns the result of
 * tox_bootstrap_from_address.
 */
int
twc_bootstrap_tox(Tox *tox, const char *address, uint16_t port,
                  const char *public_key)
{
    uint8_t binary_key[TOX_ADDRESS_SIZE];
    twc_hex2bin(public_key, TOX_ADDRESS_SIZE, binary_key);
    TOX_ERR_BOOTSTRAP err;

    int result = tox_bootstrap(tox, address, port, binary_key, &err);

    return result;
}

/**
 * Bootstrap a Tox object with a random DHT bootstrap node.
 */
void
twc_bootstrap_random_node(Tox *tox)
{
    int i = rand() % twc_bootstrap_count;
    struct t_twc_bootstrap_node const *const node = &twc_bootstrap_nodes[i];
    twc_bootstrap_tox(tox, node->address, node->port, node->key);
}
